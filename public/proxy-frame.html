<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>New Tab - senninproxy</title>
<style>
/* =========================================
   Chrome Refresh 2023 Design Tokens
========================================= */
:root {
  --chrome-bg: #f1f3f4;
  --chrome-tab-active: #ffffff;
  --chrome-tab-hover: rgba(60, 64, 67, 0.08);
  --chrome-toolbar: #ffffff;
  --chrome-border: #dee1e6;
  --chrome-text: #1f1f1f;
  --chrome-muted: #474747;
  --chrome-accent: #1a73e8;
  --sennin-blue: #4f9cff;
  --radius-tab: 12px;
  --radius-input: 24px;
  --ease-out: cubic-bezier(0.2, 0, 0, 1);
  --dur: 0.2s;
}
@media (prefers-color-scheme: dark) {
  :root {
    --chrome-bg: #202124;
    --chrome-tab-active: #35363a;
    --chrome-tab-hover: rgba(255, 255, 255, 0.1);
    --chrome-toolbar: #35363a;
    --chrome-border: #1c1c1e;
    --chrome-text: #e3e3e3;
    --chrome-muted: #9aa0a6;
    --chrome-accent: #8ab4f8;
  }
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0; height: 100vh;
  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--chrome-bg);
  color: var(--chrome-text);
  display: flex; flex-direction: column;
  overflow: hidden;
}

/* =========================================
   Tabs Animation & UI
========================================= */
.tab-strip {
  height: 44px;
  display: flex;
  align-items: flex-end;
  padding-left: 8px;
  padding-right: 8px;
  gap: 0px;
  -webkit-user-select: none;
}
.tab {
  position: relative;
  height: 34px;
  width: 240px;
  background: transparent;
  border-radius: var(--radius-tab) var(--radius-tab) 0 0;
  display: flex;
  align-items: center;
  padding: 0 8px 0 16px;
  font-size: 12px;
  cursor: default;
  transition: background var(--dur) var(--ease-out), width 0.3s var(--ease-out);
  animation: tabAppear 0.3s var(--ease-out);
}
@keyframes tabAppear {
  from { width: 0; opacity: 0; transform: translateY(10px); }
  to { width: 240px; opacity: 1; transform: translateY(0); }
}
.tab.active {
  background: var(--chrome-toolbar);
  box-shadow: 0 -1px 0 rgba(0,0,0,0.05);
}
.tab-title {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  pointer-events: none;
}
.close-tab {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 4px;
  cursor: pointer;
  color: var(--chrome-muted);
  transition: background 0.2s, color 0.2s;
}
.close-tab:hover {
  background: var(--chrome-tab-hover);
  color: var(--chrome-text);
}
.close-tab svg { width: 14px; height: 14px; }

.new-tab-btn {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: transparent;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  margin-bottom: 4px;
  margin-left: 4px;
  color: var(--chrome-muted);
  transition: background var(--dur);
}
.new-tab-btn:hover { background: var(--chrome-tab-hover); }

/* =========================================
   Toolbar & Omnibox
========================================= */
.toolbar {
  height: 48px;
  background: var(--chrome-toolbar);
  display: flex;
  align-items: center;
  padding: 0 10px;
  gap: 8px;
  border-bottom: 1px solid var(--chrome-border);
}
.nav-btns { display: flex; gap: 2px; }
.nav-btn {
  width: 34px; height: 34px;
  border-radius: 50%;
  border: none;
  background: transparent;
  color: var(--chrome-text);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: background var(--dur);
}
.nav-btn:hover { background: var(--chrome-tab-hover); }
.nav-btn:active { transform: scale(0.92); }
.nav-btn:disabled { opacity: 0.3; cursor: default; }

.omnibox {
  flex: 1;
  height: 34px;
  background: var(--chrome-bg);
  border-radius: var(--radius-input);
  display: flex;
  align-items: center;
  padding: 0 16px;
  transition: box-shadow 0.1s;
}
.omnibox:focus-within {
  background: var(--chrome-toolbar);
  box-shadow: 0 0 0 2px var(--chrome-accent);
}
.omnibox-input {
  width: 100%;
  background: transparent;
  border: none;
  font-size: 14px;
  color: var(--chrome-text);
  margin-left: 10px;
}

/* =========================================
   Content Area
========================================= */
.content-area {
  flex: 1;
  background: var(--chrome-tab-active);
  position: relative;
  overflow: hidden;
}
.view-container {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0; left: 0;
  display: none;
}
.view-container.active { display: block; }
iframe {
  width: 100%;
  height: 100%;
  border: none;
  background: #fff;
}

.loading-bar {
  position: absolute;
  top: 0; left: 0;
  height: 3px;
  width: 0%;
  background: var(--chrome-accent);
  transition: width 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
  z-index: 100;
}

.sennin-logo {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  pointer-events: none;
  z-index: 5;
}
.sennin-logo h1 {
  font-size: clamp(48px, 12vw, 88px);
  margin: 0;
  color: var(--sennin-blue);
  letter-spacing: -2px;
  font-weight: 600;
}

#custom-menu {
  position: fixed;
  display: none;
  z-index: 9999;
  background: var(--chrome-toolbar);
  border: 1px solid var(--chrome-border);
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  border-radius: 12px;
  padding: 6px 0;
  min-width: 220px;
  animation: menuOpen 0.15s var(--ease-out);
  transform-origin: top left;
}
@keyframes menuOpen {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
.menu-item {
  padding: 8px 16px;
  font-size: 13px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: space-between;
}
.menu-item:hover { background: var(--chrome-tab-hover); }
.menu-item .shortcut { color: var(--chrome-muted); font-size: 11px; }
</style>
</head>
<body>

<div class="loading-bar" id="loadingBar"></div>

<div id="custom-menu">
  <div class="menu-item" onclick="goHome()">
    <span>ホームに戻る</span>
    <span class="shortcut">Alt+Home</span>
  </div>
  <div style="height:1px; background:var(--chrome-border); margin:4px 0;"></div>
  <div class="menu-item" onclick="createTab()">
    <span>新しいタブ</span>
    <span class="shortcut">Ctrl+T</span>
  </div>
  <div class="menu-item" onclick="location.reload()">
    <span>再読み込み</span>
    <span class="shortcut">Ctrl+R</span>
  </div>
</div>

<header class="tab-strip" id="tabs">
  <button class="new-tab-btn" onclick="createTab()">+</button>
</header>

<div class="toolbar">
  <div class="nav-btns">
    <button class="nav-btn" title="戻る" onclick="goBack()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
    </button>
    <button class="nav-btn" title="進む" onclick="goForward()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
    </button>
    <button class="nav-btn" title="再読み込み" onclick="reloadTab()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
    </button>
  </div>
  
  <form id="uv-form" class="omnibox">
    <input id="uv-address" type="text" class="omnibox-input" 
           placeholder="senninproxy で検索または URL を入力" autocomplete="off">
  </form>

  <div class="nav-btns">
    <button class="nav-btn" id="menu-trigger">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
    </button>
  </div>
</div>

<main class="content-area" id="viewport">
  <div class="sennin-logo" id="home-logo">
    <h1>senninproxy</h1>
  </div>
  </main>

<script src="/uv/uv.bundle.js"></script>
<script src="/uv/uv.config.js"></script>

<script>
let tabCounter = 0;
let activeTabId = null;
const tabsContainer = document.getElementById("tabs");
const loadingBar = document.getElementById("loadingBar");
const addressInput = document.getElementById("uv-address");
const customMenu = document.getElementById("custom-menu");
const menuTrigger = document.getElementById("menu-trigger");
const viewport = document.getElementById("viewport");
const homeLogo = document.getElementById("home-logo");

// --- Tab Logic ---

function createTab(name = "新しいタブ") {
  const id = "tab-" + (++tabCounter);
  
  // Tab element
  const tab = document.createElement("div");
  tab.className = "tab active";
  tab.dataset.id = id;
  tab.innerHTML = `
    <span class="tab-title">${name}</span>
    <div class="close-tab" title="タブを閉じる">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </div>
  `;

  // Iframe container
  const container = document.createElement("div");
  container.className = "view-container active";
  container.id = "view-" + id;
  const iframe = document.createElement("iframe");
  container.appendChild(iframe);
  viewport.appendChild(container);

  tab.onclick = (e) => {
    if (e.target.closest('.close-tab')) return;
    switchTab(id);
  };

  const closeBtn = tab.querySelector('.close-tab');
  closeBtn.onclick = (e) => {
    e.stopPropagation();
    closeTab(id);
  };

  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".view-container").forEach(v => v.classList.remove("active"));
  
  tabsContainer.insertBefore(tab, document.querySelector(".new-tab-btn"));
  activeTabId = id;
  addressInput.value = "";
  updateHomeVisibility();
}

function switchTab(id) {
  const t = document.querySelector(`.tab[data-id="${id}"]`);
  if (!t) return;
  
  document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
  document.querySelectorAll(".view-container").forEach(v => v.classList.remove("active"));
  
  t.classList.add("active");
  document.getElementById("view-" + id).classList.add("active");
  activeTabId = id;

  const iframe = document.querySelector(`#view-${id} iframe`);
  if (iframe && iframe.src && iframe.src !== "about:blank") {
    // もしUVでデコードできるならデコードして表示
    try {
      const currentProxyUrl = new URL(iframe.contentWindow.location.href).pathname.split(__uv$config.prefix).pop();
      addressInput.value = __uv$config.decodeUrl(currentProxyUrl);
    } catch(e) {
      addressInput.value = "";
    }
  } else {
    addressInput.value = "";
  }
  updateHomeVisibility();
}

function closeTab(id) {
  const t = document.querySelector(`.tab[data-id="${id}"]`);
  const v = document.getElementById("view-" + id);
  if (!t) return;

  const wasActive = t.classList.contains('active');
  const nextTab = t.nextElementSibling.classList.contains('tab') ? t.nextElementSibling : t.previousElementSibling;

  t.remove();
  v.remove();

  if (wasActive && nextTab && nextTab.classList.contains('tab')) {
    switchTab(nextTab.dataset.id);
  } else if (!document.querySelector('.tab')) {
    createTab();
  }
  updateHomeVisibility();
}

function updateHomeVisibility() {
  const activeView = document.querySelector(`#view-${activeTabId} iframe`);
  if (!activeView || activeView.src === "" || activeView.src === "about:blank") {
    homeLogo.style.display = "block";
  } else {
    homeLogo.style.display = "none";
  }
}

// --- Navigation ---

function goHome() {
  const iframe = document.querySelector(`#view-${activeTabId} iframe`);
  iframe.src = "about:blank";
  document.querySelector(`.tab[data-id="${activeTabId}"] .tab-title`).textContent = "新しいタブ";
  addressInput.value = "";
  updateHomeVisibility();
  hideMenu();
}

function reloadTab() {
  const iframe = document.querySelector(`#view-${activeTabId} iframe`);
  if (iframe) iframe.contentWindow.location.reload();
}

function goBack() {
  const iframe = document.querySelector(`#view-${activeTabId} iframe`);
  if (iframe) iframe.contentWindow.history.back();
}

function goForward() {
  const iframe = document.querySelector(`#view-${activeTabId} iframe`);
  if (iframe) iframe.contentWindow.history.forward();
}

// --- UV Logic ---

async function registerSW() {
  if ("serviceWorker" in navigator) {
    await navigator.serviceWorker.register("/sw.js", { scope: __uv$config.prefix });
  }
}

document.getElementById("uv-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const val = addressInput.value.trim();
  if (!val) return;

  await registerSW();
  startLoading();

  let url = val;
  if (!val.includes(".") && !val.startsWith("http")) {
    url = "https://www.google.com/search?q=" + encodeURIComponent(val);
  } else if (!val.startsWith("http")) {
    url = "https://" + val;
  }

  const encodedUrl = __uv$config.prefix + __uv$config.encodeUrl(url);
  const iframe = document.querySelector(`#view-${activeTabId} iframe`);
  
  iframe.src = encodedUrl;
  document.querySelector(`.tab[data-id="${activeTabId}"] .tab-title`).textContent = val;
  
  iframe.onload = () => {
    finishLoading();
    updateHomeVisibility();
  };
});

// --- Menu Logic ---

function showMenu(x, y) {
  customMenu.style.display = "block";
  if (x + 220 > window.innerWidth) x -= 220;
  customMenu.style.left = x + "px";
  customMenu.style.top = y + "px";
}

function hideMenu() { customMenu.style.display = "none"; }

window.addEventListener("contextmenu", (e) => {
  e.preventDefault();
  showMenu(e.pageX, e.pageY);
});

menuTrigger.addEventListener("click", (e) => {
  e.stopPropagation();
  const rect = menuTrigger.getBoundingClientRect();
  showMenu(rect.left - 180, rect.bottom + 8);
});

window.addEventListener("click", hideMenu);

// --- Progress Bar ---

function startLoading() {
  loadingBar.style.transition = "none";
  loadingBar.style.width = "0%";
  setTimeout(() => {
    loadingBar.style.transition = "width 0.4s cubic-bezier(0.1, 0.7, 0.1, 1)";
    loadingBar.style.width = "75%";
  }, 10);
}

function finishLoading() {
  loadingBar.style.width = "100%";
  setTimeout(() => { loadingBar.style.width = "0%"; }, 300);
}

// --- Init ---
createTab();
</script>
</body>
</html>
